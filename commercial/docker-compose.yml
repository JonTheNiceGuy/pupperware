version: '3.7'
services:
  puppet:
    image: artifactory.delivery.puppetlabs.net/pe-and-platform/pe-puppetserver:2019.1.0.92
    hostname: puppet.test
    environment:
      - PUPPETDB_HOSTNAME=puppetdb.test
      - PE_CONSOLE_SERVICES_HOSTNAME=pe-console-services.test
    ports:
      - 8140:8140
    dns_search: test
    networks:
      test:
        aliases:
         - puppet.test
  pe-orchestration-services:
    image: artifactory.delivery.puppetlabs.net/pe-and-platform/pe-orchestration-services:2019.1.1.11
    hostname: pe-orchestration-services.test
    environment:
      - PUPPETSERVER_HOSTNAME=puppet.test
      - PUPPETDB_HOSTNAME=puppetdb.test
      - POSTGRES_HOSTNAME=postgres.test
      - PE_CONSOLE_SERVICES_HOSTNAME=pe-console-services.test
    ports:
      - 8142:8142
      - 8143:8143
    depends_on:
      - puppet
    dns_search: test
    networks:
      test:
        aliases:
         - pe-orchestration-services.test
  pe-console-services:
    image: artifactory.delivery.puppetlabs.net/pe-and-platform/pe-console-services:2019.1.2.0
    hostname: pe-console-services.test
    environment:
      - PUPPETSERVER_HOSTNAME=puppet.test
      - PUPPETDB_HOSTNAME=puppetdb.test
      - POSTGRES_HOSTNAME=postgres.test
      - PE_ORCHESTRATION_SERVICES_HOSTNAME=pe-orchestration-services.test
    ports:
      - 443:4431
      - 4430:4430
      - 4432:4432
      - 4433:4433
    depends_on:
      - postgres
      - puppet
    dns_search: test
    networks:
      test:
        aliases:
          - pe-console-services.test
  puppetdb:
    image: puppet/puppetdb
    hostname: puppetdb.test
    environment:
      - PUPPETSERVER_HOSTNAME=puppet.test
      - PUPPETDB_POSTGRES_HOSTNAME=postgres.test
      - PUPPETDB_PASSWORD=puppetdb
      - PUPPETDB_USER=puppetdb
    ports:
      - 8080
      - 8081
    depends_on:
      - postgres
      - puppet
    dns_search: test
    networks:
      test:
        aliases:
          - puppetdb.test
  postgres:
    image: artifactory.delivery.puppetlabs.net/pe-and-platform/pe-postgres
    hostname: postgres.test
    environment:
      - CERTNAME=postgres.test
      - PUPPETSERVER_HOSTNAME=puppet.test
    expose:
      - 5432
    dns_search: test
    networks:
      test:
        aliases:
          - postgres.test
  puppet-agent:
    image: puppet/puppet-agent-ubuntu
    hostname: puppet-agent.test
    networks:
      test:
        aliases:
          - puppet-agent.test
    entrypoint: /bin/bash
    command: -c "echo 'waiting for orchestration services to be up' &&
                 while true; do if curl -k --fail --silent https://pe-orchestration-services.test:8143/status/v1/simple; then break; fi; done &&
                 puppet config set server puppet.test &&
                 puppet agent -t &&
                 echo 'starting pxp services' &&
                 pxp-agent --broker-ws-uri wss://pe-orchestration-services.test:8142/pcp2/
                           --ssl-ca-cert /etc/puppetlabs/puppet/ssl/certs/ca.pem
                           --ssl-cert /etc/puppetlabs/puppet/ssl/certs/puppet-agent.test.pem
                           --ssl-key /etc/puppetlabs/puppet/ssl/private_keys/puppet-agent.test.pem
                           --pcp-version 2"
networks:
  test:
    name: pupperware-commercial
