#! /bin/sh

set -e

cd "$(dirname "$0")/.." 

echo "* * * * * * * *"
echo "  Changing the database password will restart your running Puppet containers"
echo "* * * * * * * *"
echo ""
echo "Would you like to continue? [y/n]"

read -r restart

while [ "$restart" != 'y' ] && [ "$restart" != 'Y' ] && [ "$restart" != 'n' ] && [ "$restart" != 'N' ]; do
  echo "Would you like to continue? [y/n]"
  read -r restart
done

if [ "$restart" = 'n' ] || [ "$restart" = 'N' ]; then
  echo "Exiting..."
  exit 0
fi

echo ""

stty -echo

printf "New database password: "
read -r dbpassword
echo ""

printf "Confirm new database password: "
read -r dbconfirm
echo ""

stty echo

if [ "$dbpassword" != "$dbconfirm" ]; then
  echo "Passwords didn't match, exiting!"
  exit 1
fi

# change the password in postgresql
docker-compose exec postgres /bin/bash -c "psql -U \$POSTGRES_USER -c \"ALTER USER \$POSTGRES_USER PASSWORD '$dbpassword'\";"


# update the password in the environment sections of docker-compose
# We don't really care about having the backup files here, but inline
# substitution with an empty backup extension gets hairy when considering
# cross-platform compatibility
sed -i.bak "s/PUPPETDB_PASSWORD=.*$/PUPPETDB_PASSWORD=$dbpassword/" docker-compose.yml && rm docker-compose.yml.bak
sed -i.bak "s/POSTGRES_PASSWORD=.*$/POSTGRES_PASSWORD=$dbpassword/" docker-compose.yml && rm docker-compose.yml.bak

docker-compose stop
# rebuild the postgres and puppetdb containers to pick up the environment change
# and bring everything back up
docker-compose up -d --build
