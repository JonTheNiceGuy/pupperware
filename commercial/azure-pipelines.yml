# Don't run Azure when a branch is updated, only when a PR is updated.
# Prevents double builds when a PR is made from the main repo and not a fork.
trigger: none
pr:
  autoCancel: true
  branches:
    include:
    - '*'

pool:
  # self-hosted agent on Windows 10 1903 environment
  # includes newer Docker engine with LCOW enabled, new build of LCOW image
  # includes Ruby 2.5, Go 1.10, Node.js 10.10
  name: Internal LCOW

variables:
  COMPOSE_PROJECT_NAME: pupperware-commercial

workspace:
  clean: resources

steps:
- checkout: self  # self represents the repo where the initial Pipelines YAML file was found
  clean: true  # whether to fetch clean each time
- powershell: |
    $gemfile = Join-Path -Path (Get-Location) -ChildPath 'Gemfile'
    $gempath = Join-Path -Path (Get-Location) -ChildPath '.bundle/gems'
    bundle config --local gemfile $gemfile
    bundle config --local path $gempath
    bundle install --with test
  displayName: Fetch Dependencies
  timeoutInMinutes: 1
  name: fetch_deps

- powershell: |
    . "$(bundle show pupperware)/ci/build.ps1"
    Write-HostDiagnostics
  displayName: Diagnostic Host Information
  timeoutInMinutes: 2
  name: hostinfo

- powershell: |
    . "$(bundle show pupperware)/ci/build.ps1"
    Initialize-TestEnv
  displayName: Prepare Test Environment
  name: test_prepare

- powershell: |
    . "$(bundle show pupperware)/ci/build.ps1"
    Write-Host "Pulling images..."
    docker-compose pull --quiet
    bundle exec rspec spec/
  displayName: Test $(COMPOSE_PROJECT_NAME)
  timeoutInMinutes: 30
  name: test

- task: PublishTestResults@2
  displayName: Publish $(COMPOSE_PROJECT_NAME) Test Results
  inputs:
    testResultsFormat: 'JUnit'
    testResultsFiles: 'TEST-*.xml'
    testRunTitle: $(COMPOSE_PROJECT_NAME) Test Results
  condition: always()

- powershell: |
    . "$(bundle show pupperware)/ci/build.ps1"
    Clear-BuildState
  displayName: Build Cleanup
  timeoutInMinutes: 4
  condition: always()
